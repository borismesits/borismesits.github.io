<!DOCTYPE html>
<html>
<head>
	<title>Parameteric Amplification Applet</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" href="assets/css/main.css" />
    <script type="text/javascript">
    window.languagePluginUrl = 'https://cdn.jsdelivr.net/pyodide/v0.15.0/full/';
    </script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.15.0/full/pyodide.js"></script>
</head>

<body class="subpage">

	<!-- Header -->
		<header id="header">
			<div class="inner">
				<a href="applets.html" class="logo">Back to Applets</a>
				<nav id="nav">
			</div>
			<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
			<script id="MathJax-script" async
				src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
			</script>
		</header>
			
	<!-- Three -->
			<section id="three" class="wrapper">
				<div class="inner" id="container">		
				<p></p>
				<header>
				<h2>Parametric Amplification</h2> 
				</header>
				<p id='text'> This solves the Duffing equation 
				\[
				x'' + 2 \beta x' + \omega^2 (x + x^3) = F \cos (\omega_s t)
				\]
				with an RK4 routine.
				</p>
				<button onclick='evaluatePython()'>Start Generator</button> <!-- Button that runs the JS code! -->
				<br>
				<br>
				<div>
				Console:
				</div>
				<textarea id='output' style='width: 100%;' rows='6' disabled></textarea>

				<script> <!-- this JS script runs on startup -->
    const output = document.getElementById("output");
    const text = document.getElementById("text");
	
	addToOutput('Starting...')

	addToOutput('Initializing...')

    function addToOutput(s) {
      output.value += '>>> ' + s + '\n';
    }

	//the follwing is python code that contains almost all the python we want to do
	code = `
from js import document # for interacting with JS
import io, base64 # for saving the figure

import numpy as np
import matplotlib.pyplot as plt


# This attempts to demonstrate appearance of sideband frequencies for 
# weak parametric drive.


def f(x,t):
        
    x1 = x[0]
    x2 = x[1]
    
    isOn = 1
    
    beta = 1000
    
    omega_s = 100 * 2*np.pi
    
    omega_0 = 100 * 2*np.pi
    
    omega_d = 200 * 2*np.pi
    
    RHS = 0*1e7*np.cos(omega_d*t) + 1e4*np.cos(omega_s*t)
    
    dx1dt = x2
    dx2dt = -2*beta*x2 - (omega_0**2)* (x1 + x1**3) + RHS
    
    return np.array([dx1dt,dx2dt])



def paramp(isOn,t,x):
    
    dt = t[1] - t[0]
    
    for i in range(0, len(t)-1):#
        
        k1 = f(x[i,:], t[i])
        k2 = f(x[i,:] + k1*dt/2, t[i] + dt/2) 
        k3 = f(x[i,:] + k2*dt/2, t[i] + dt/2) 
        k4 = f(x[i,:] + k3*dt, t[i] + dt) 
        
        x[i+1,:] = x[i,:] + (dt/6)*(k1 + 2*k2 + 2*k3 + k4)
        
        
    for i in range(0,1):
        #plt.plot(t,x[:,i]) 
        pass
        
    return t, x

	
def plot_paramp():
    N = 2

    t = np.linspace(0,1,1000)
    x = np.zeros([len(t),N])
    x0 = np.array([1,1])*0
    x[0,:] = x0

    t, x1 = paramp(True,t,x)

    fig = plt.figure(1)

    ax1 = fig.add_subplot(1, 1, 1)
    ax1.grid()
    ax1.plot(t,x1,label='paramp')
    ax1.legend()

div_container = document.createElement('div') # now we call some HTML from python to add it to the page
div_container.innerHTML = '''
<br>
<br>
<h> Generator Ready!
</h>
<p>
These are the generator controls. The persistence and lacunarity are two numbers that determine the style of terrain - mess around to see what you get! I
personally like both values set to 3.
</p>
<br>
Persistence:
<input id='mu' value='1' type="number">
<br><br>
Lacunarity:
<input id='sigma' value='1' type="number">
<br><br>
Seed:
<input id='seed' value='1' type="number">
<br><br>
<button onclick='pyodide.globals.generate_plot_img()'>Plot</button>
<br>
<img id="fig" />''' 
document.getElementById("container").appendChild(div_container)

def generate_plot_img():
	# get values from inputs
	print('1')
	mu = int(document.getElementById('mu').value)
	sigma = int(document.getElementById('sigma').value)  # generate an interval
	seed = int(document.getElementById('seed').value)  # generate an interval
	print('2')
	persistence = 1+ 0.1*mu
	lacunarity = 1+ 0.1*sigma

	plot_paramp()
	print('3')
	buf = io.BytesIO()
	# copy the plot into the buffer
	plt.savefig(buf, format='png')
	buf.seek(0)
	print('4')
	# encode the image as Base64 string
	img_str = 'data:image/png;base64,' + base64.b64encode(buf.read()).decode('UTF-8')  # show the image
	img_tag = document.getElementById('fig')
	img_tag.src = img_str
	buf.close()
	print('5')
`
//end of python code
    
    // init pyodide
    languagePluginLoader.then(() => { addToOutput('Ready!'); });

    function evaluatePython() {
		addToOutput('Loading Generator...');
		console.log(pyodide.runPythonAsync(code));
    }

	</script>
	</div>
	</section>
  <!-- Footer -->
			<footer id="footer">
				<div class="inner">
					<div class="flex">
						<div class="copyright">
							&copy; Untitled. Design: <a href="https://templated.co">TEMPLATED</a>. Images: <a href="https://unsplash.com">Unsplash</a>.
						</div>
						<ul class="icons">
							<li><a href="#" class="icon fa-facebook"><span class="label">Facebook</span></a></li>
							<li><a href="#" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
							<li><a href="#" class="icon fa-linkedin"><span class="label">linkedIn</span></a></li>
							<li><a href="#" class="icon fa-pinterest-p"><span class="label">Pinterest</span></a></li>
							<li><a href="#" class="icon fa-vimeo"><span class="label">Vimeo</span></a></li>
						</ul>
					</div>
				</div>
			</footer>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/skel.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
</body>

</html>